# **DEP-014: Deployment Strategy Document**

## **Yajid - Lifestyle & Social Discovery Super App**

**Document Version:** 1.0  
**Date:** September 06, 2025  
**Author:** Hassan Chraibi, Senior DevOps Engineer  
**Reviewers:** Ahmed Benali (Technical Lead), Rachid Alami (Backend Lead), Mohamed Hassan (Project Manager)  
**Approver:** Ahmed Benali, Technical Lead  
**Status:** Approved  
**Next Review Date:** September 20, 2025

## **Document Control**

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-09-06 | Hassan Chraibi | Initial deployment strategy with Flutter CI/CD |

---

## **Executive Summary**

This Deployment Strategy Document (DEP-014) defines the comprehensive deployment approach for the Yajid platform, implementing continuous delivery practices with zero-downtime deployments. The strategy leverages Google Cloud Platform for infrastructure, GitHub Actions for CI/CD, and Flutter-specific build pipelines.

The deployment architecture supports automated releases to both iOS App Store and Google Play Store, with staged rollouts, automated testing, and rollback capabilities. All financial transactions use MAD currency with strict validation at deployment gates.

---

## **1. Deployment Architecture**

### **1.1 Infrastructure Overview**

```
┌──────────────────────────────────────────────┐
│            GitHub Repository                  │
│         (Source Code + Configs)               │
└────────────────┬─────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────────────┐
│           GitHub Actions CI/CD               │
│     (Build, Test, Security Scan, Deploy)     │
└────────────────┬─────────────────────────────┘
                 │
      ┌──────────┴──────────┬──────────────┐
      ▼                     ▼               ▼
┌──────────┐         ┌──────────┐    ┌──────────┐
│   Dev    │         │ Staging  │    │   Prod   │
│  (GKE)   │         │  (GKE)   │    │  (GKE)   │
└──────────┘         └──────────┘    └──────────┘
```

### **1.2 Environment Configuration**

| Environment | Purpose | URL | Auto-Deploy |
|------------|---------|-----|-------------|
| **Development** | Developer testing | dev.yajid.ma | On commit |
| **Staging** | UAT & Integration | staging.yajid.ma | On PR merge |
| **Production** | Live system | api.yajid.ma | Manual approval |

### **1.3 Technology Stack**

| Component | Technology | Version |
|-----------|------------|---------|
| **Container Orchestration** | Google Kubernetes Engine | 1.27 |
| **Container Registry** | Google Artifact Registry | Latest |
| **CI/CD** | GitHub Actions | Latest |
| **Monitoring** | Google Cloud Operations | Latest |
| **CDN** | Cloudflare | Enterprise |
| **Mobile Distribution** | App Store Connect, Google Play Console | Latest |

---

## **2. CI/CD Pipeline**

### **2.1 Pipeline Stages**

```yaml
name: Deployment Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Stage 1: Code Quality
  quality:
    runs-on: ubuntu-latest
    steps:
      - Flutter analyze
      - Dart format check
      - Code coverage (>80%)
      
  # Stage 2: Security Scan
  security:
    runs-on: ubuntu-latest
    steps:
      - SAST scan
      - Dependency check
      - License compliance
      
  # Stage 3: Build
  build:
    strategy:
      matrix:
        platform: [ios, android, web]
    steps:
      - Flutter build
      - Docker build
      - Upload artifacts
      
  # Stage 4: Test
  test:
    runs-on: ubuntu-latest
    steps:
      - Unit tests
      - Integration tests
      - E2E tests
      
  # Stage 5: Deploy
  deploy:
    needs: [quality, security, build, test]
    steps:
      - Deploy to target environment
      - Run smoke tests
      - Health checks
```

### **2.2 Branch Strategy**

```
main            → Production (manual approval)
├── develop     → Staging (auto-deploy)
│   ├── feature/xxx → Development (auto-deploy)
│   ├── bugfix/xxx  → Development (auto-deploy)
│   └── hotfix/xxx  → Fast-track to production
└── release/x.x → Release candidates
```

### **2.3 Version Management**

**Semantic Versioning:** MAJOR.MINOR.PATCH
- **MAJOR:** Breaking changes
- **MINOR:** New features
- **PATCH:** Bug fixes

**Build Numbering:**
- iOS: Auto-incremented build number
- Android: Version code based on timestamp
- Backend: Git SHA for traceability

---

## **3. Mobile App Deployment**

### **3.1 Flutter Build Configuration**

```yaml
# pubspec.yaml
version: 1.0.0+1  # version+build_number

# Build commands
flutter build ios --release --build-name=1.0.0 --build-number=$BUILD_NUMBER
flutter build appbundle --release --build-name=1.0.0 --build-number=$BUILD_NUMBER
```

### **3.2 iOS Deployment**

**TestFlight Process:**
1. Build IPA with certificates
2. Upload to App Store Connect
3. Internal testing (team)
4. External testing (beta users)
5. Submit for review
6. Production release

**Fastlane Configuration:**
```ruby
lane :release do
  build_ios_app(
    scheme: "yajid",
    export_options: {
      provisioningProfiles: {
        "ma.yajid.app" => "Yajid Distribution"
      }
    }
  )
  upload_to_testflight
  submit_for_review
end
```

### **3.3 Android Deployment**

**Google Play Process:**
1. Build AAB (Android App Bundle)
2. Sign with upload key
3. Upload to Play Console
4. Internal testing track
5. Closed testing (beta)
6. Staged rollout (10% → 50% → 100%)

**Gradle Configuration:**
```gradle
android {
    defaultConfig {
        applicationId "ma.yajid.app"
        minSdkVersion 21
        targetSdkVersion 33
        versionCode System.getenv("BUILD_NUMBER") ?: 1
        versionName "1.0.0"
    }
    
    signingConfigs {
        release {
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
            storeFile file(System.getenv("KEYSTORE_PATH"))
            storePassword System.getenv("KEYSTORE_PASSWORD")
        }
    }
}
```

---

## **4. Backend Deployment**

### **4.1 Kubernetes Deployment**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yajid-backend
  namespace: production
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: yajid-backend
  template:
    metadata:
      labels:
        app: yajid-backend
        version: v1.0.0
    spec:
      containers:
      - name: backend
        image: gcr.io/yajid-platform/backend:1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

### **4.2 Database Migration Strategy**

```sql
-- Migration process
BEGIN TRANSACTION;

-- 1. Create new schema version
CREATE SCHEMA yajid_v2;

-- 2. Apply migrations
\i migrations/v1.0.0_initial_schema.sql
\i migrations/v1.0.1_add_auctions.sql
\i migrations/v1.0.2_remove_lottery.sql

-- 3. Validate data integrity
SELECT validate_migration('v1.0.2');

-- 4. Switch to new schema
ALTER SCHEMA yajid RENAME TO yajid_old;
ALTER SCHEMA yajid_v2 RENAME TO yajid;

COMMIT;
```

---

## **5. Deployment Process**

### **5.1 Pre-Deployment Checklist**

- [ ] All tests passing (>80% coverage)
- [ ] Security scan clean
- [ ] Code review approved
- [ ] Documentation updated
- [ ] Database migrations tested
- [ ] Rollback plan prepared
- [ ] Stakeholders notified

### **5.2 Deployment Steps**

**Step 1: Preparation (30 minutes)**
```bash
# Tag release
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# Create release branch
git checkout -b release/1.0.0
```

**Step 2: Build & Test (45 minutes)**
```bash
# Build all platforms
flutter build ios --release
flutter build appbundle --release
docker build -t yajid-backend:1.0.0 .

# Run final tests
flutter test
npm test
```

**Step 3: Deploy to Staging (30 minutes)**
```bash
# Deploy backend
kubectl apply -f k8s/staging/
kubectl rollout status deployment/yajid-backend -n staging

# Deploy mobile apps
fastlane ios beta
fastlane android beta
```

**Step 4: Validation (60 minutes)**
- Smoke tests
- User acceptance testing
- Performance validation
- Security verification

**Step 5: Production Deployment (45 minutes)**
```bash
# Backend deployment
kubectl apply -f k8s/production/
kubectl rollout status deployment/yajid-backend -n production

# Mobile deployment
fastlane ios release
fastlane android production
```

### **5.3 Rollback Procedure**

```bash
# Immediate rollback (< 5 minutes)
kubectl rollout undo deployment/yajid-backend -n production

# Version-specific rollback
kubectl rollout undo deployment/yajid-backend --to-revision=2 -n production

# Mobile app rollback
# iOS: Expedited review for critical fix
# Android: Halt staged rollout, push fix
```

---

## **6. Configuration Management**

### **6.1 Environment Variables**

```yaml
# config/production.yaml
environment: production
database:
  host: ${DB_HOST}
  port: 5432
  name: yajid_prod
  ssl: true
  
redis:
  host: ${REDIS_HOST}
  port: 6379
  
firebase:
  projectId: yajid-platform
  
payment:
  currency: MAD
  gateway: cmi
  
features:
  auctions: true  # Lottery removed for compliance
  social: true
  ar_support: false
```

### **6.2 Secrets Management**

**Google Secret Manager:**
```bash
# Create secrets
gcloud secrets create db-password --data-file=db-pass.txt
gcloud secrets create jwt-secret --data-file=jwt.txt
gcloud secrets create payment-api-key --data-file=payment.txt

# Grant access
gcloud secrets add-iam-policy-binding db-password \
  --member=serviceAccount:yajid-backend@project.iam.gserviceaccount.com \
  --role=roles/secretmanager.secretAccessor
```

---

## **7. Monitoring & Alerts**

### **7.1 Health Checks**

```javascript
// Health check endpoint
app.get('/health', (req, res) => {
  const health = {
    status: 'UP',
    timestamp: new Date().toISOString(),
    services: {
      database: checkDatabase(),
      redis: checkRedis(),
      firebase: checkFirebase()
    }
  };
  
  const httpStatus = health.status === 'UP' ? 200 : 503;
  res.status(httpStatus).json(health);
});
```

### **7.2 Deployment Metrics**

| Metric | Target | Alert Threshold |
|--------|--------|-----------------|
| **Deployment Success Rate** | >95% | <90% |
| **Mean Time to Deploy** | <30 min | >60 min |
| **Rollback Rate** | <5% | >10% |
| **Failed Deployments** | <2/month | >5/month |
| **Deployment Frequency** | 2/week | <1/week |

### **7.3 Alert Configuration**

```yaml
alerts:
  - name: deployment-failed
    condition: deployment.status == "failed"
    channels: [slack, email, pagerduty]
    
  - name: high-error-rate
    condition: error_rate > 1%
    duration: 5m
    channels: [slack, pagerduty]
    
  - name: slow-deployment
    condition: deployment_time > 60m
    channels: [slack]
```

---

## **8. Disaster Recovery**

### **8.1 Backup Strategy**

| Component | Backup Frequency | Retention | Recovery Time |
|-----------|-----------------|-----------|---------------|
| **Database** | Continuous | 30 days | <1 hour |
| **User Files** | Daily | 90 days | <2 hours |
| **Configuration** | On change | Unlimited | <15 minutes |
| **Code** | Every commit | Unlimited | <5 minutes |

### **8.2 Recovery Procedures**

**Scenario 1: Region Failure**
1. Detect failure (automated)
2. Failover to DR region (5 minutes)
3. Update DNS (5 minutes)
4. Verify services (10 minutes)
Total RTO: 20 minutes

**Scenario 2: Data Corruption**
1. Identify corruption scope
2. Stop writes to affected data
3. Restore from last known good backup
4. Replay transaction logs
5. Validate data integrity
Total RTO: 2 hours

---

## **9. Security Deployment**

### **9.1 Security Gates**

```yaml
security_checks:
  pre_deployment:
    - dependency_scan
    - code_analysis
    - license_check
    - vulnerability_scan
    
  post_deployment:
    - penetration_test
    - ssl_verification
    - api_security_test
    - owasp_scan
```

### **9.2 Certificate Management**

```bash
# SSL certificate renewal
certbot renew --nginx \
  --cert-name yajid.ma \
  --deploy-hook "kubectl rollout restart deployment/nginx"

# Mobile app certificates
# iOS: Managed by App Store Connect
# Android: Upload key in Play Console
```

---

## **10. Performance Optimization**

### **10.1 CDN Configuration**

```javascript
// Cloudflare configuration
const cdnConfig = {
  caching: {
    level: 'aggressive',
    ttl: {
      images: 2592000,  // 30 days
      css: 86400,       // 1 day
      js: 86400,        // 1 day
      api: 0            // No cache
    }
  },
  minification: {
    js: true,
    css: true,
    html: true
  },
  compression: 'brotli',
  http3: true
};
```

### **10.2 Asset Optimization**

```yaml
# Flutter build optimization
flutter:
  assets:
    - assets/images/
    - assets/fonts/
  
  fonts:
    - family: Cairo
      fonts:
        - asset: fonts/Cairo-Regular.ttf
        - asset: fonts/Cairo-Bold.ttf
          weight: 700
          
build_runner:
  tree_shake_icons: true
  split_debug_info: true
  obfuscate: true
```

---

## **Document Approval**

### **Review Checklist**

- [x] Deployment strategy comprehensive
- [x] CI/CD pipeline defined
- [x] Mobile deployment covered
- [x] Security measures included
- [x] Rollback procedures clear
- [x] Monitoring configured
- [x] Disaster recovery planned

### **Approval Signatures**

| Role | Name | Signature | Date |
|------|------|-----------|------|
| Technical Lead | Ahmed Benali | A.Benali | Sep 6, 2025 |
| DevOps Engineer | Hassan Chraibi | H.Chraibi | Sep 6, 2025 |
| Backend Lead | Rachid Alami | R.Alami | Sep 6, 2025 |
| Project Manager | Mohamed Hassan | M.Hassan | Sep 6, 2025 |

---

**Document Control:**
- **Next Review:** September 20, 2025
- **Distribution:** Development Team, DevOps Team, Management
- **Related Documents:** SAD-009, TRD-010, QAP-025, SEC-028
- **Storage Location:** `/project-docs/deployment/`
- **Access Control:** DevOps write, Team read